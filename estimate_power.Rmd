
```{r}
# Clear R Environment
rm(list = ls())

# Load data
df <- read.csv("R_input.csv")

# Define outcome and grouping variables
outcomes <- c("gh", "hc", "pf", "rf_p", "rf_e", "sf", "bp", "ef", "ew")
group_vars <- c("m4", "msq", "ichd3b", "migraine_status")

# Parameters
Nsim <- 5000   # Number of bootstrap replicates
alpha <- 0.05  # Significance level
shift <- 5     # Imposed shift for group2
set.seed(123)  # Set seed
```

```{r}
# Define a function to estimate power
estimate_power <- function(data, outcome, group_col, shift, Nsim, alpha) {
  
  # Special handling if the grouping variable is migraine status
  if (group_col == "migraine_status") {
    data <- subset(data, migraine_status != "Negative") # Drop "Negative"
    groups <- unique(data[[group_col]])                 # Identify groups
  } else {
    
    # For other grouping variables, enforce consistent ordering
    all_groups <- unique(data[[group_col]])
    
    # Explicitly set order if both "Negative" and "Positive" exist
    if ("Negative" %in% all_groups && "Positive" %in% all_groups) {
      groups <- c("Negative", "Positive")
      
    } else {
      groups <- all_groups
      warning(paste("Grouping variable", group_col, "does not contain both 'Negative' and 'Positive' levels."))
    }
  }
  
  # Stop if grouping variable does not have exactly two levels
  if (length(groups) != 2) {
    stop(paste("Grouping variable", group_col, "does not have exactly 2 levels after filtering."))
  }
  
  # Store group labels
  g1 <- groups[1] 
  g2 <- groups[2]
  
  # Extract outcome values by group
  group1 <- data[[outcome]][data[[group_col]] == g1]
  group2 <- data[[outcome]][data[[group_col]] == g2]
  
  # Get sample sizes
  n1 <- length(group1)
  n2 <- length(group2)
  
  # Counter for number of H0 rejections
  rejections <- 0
  
  # Bootstrap loop
  for (i in 1:Nsim) {
    samp1 <- sample(c(group1, group2), size = n1, replace = TRUE)                    # Resample group 1
    samp2 <- sample(c(group1, group2), size = n2, replace = TRUE) + shift            # Resample group 2 and add shift
    p <- wilcox.test(samp1, samp2, alternative = "two.sided", exact = FALSE)$p.value # Wilcoxon test
    if (p < alpha) rejections <- rejections + 1                                      # Count rejection if p < alpha
  }
  
  # Calculate power and 95% CI
  power <- rejections / Nsim
  se <- sqrt(power * (1 - power) / Nsim)
  ci_low <- max(0, power - 1.96 * se)
  ci_high <- min(1, power + 1.96 * se)
  
  # Return results as a data frame
  return(data.frame(
    Outcome = outcome,
    Assessment = group_col,
    Level1 = g1,
    Level2 = g2,
    Power = power,
    CI_low = ci_low,
    CI_high = ci_high
  ))
}
```

```{r}
# Run power estimation across all outcomes and grouping variables
results <- do.call(rbind,
  lapply(outcomes, function(out) {
    do.call(rbind,
      lapply(group_vars, function(gr) {
        estimate_power(df, out, gr, shift, Nsim, alpha)
      })
    )
  })
)

# Print combined results
print(results)
```








